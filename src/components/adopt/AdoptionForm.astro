---
import Notice from './Notice.astro';
import AboutYou from './aboutyou/AboutYou.astro';
import ResidenceInfo from './residenceinfo/ResidenceInfo.astro';
import CatCare from './catcare/CatCare.astro';
import ExtraCats from './extraanimals/ExtraCats.astro';
import ExtraDogs from './extraanimals/ExtraDogs.astro';
import Lifestyle from './lifestyle/Lifestyle.astro';
import Signature from './Signature.astro';
---
<!-- Adoption Form -->
<section>
    <div class="inner">
        <form id="adoption-form" name="adoption" method="POST" data-netlify="true">
            <div class="row gtr-uniform">
                <input type="hidden" name="subject" value="adoption" />

                <Notice />
                <AboutYou />
                <ResidenceInfo />
                <CatCare />
                <ExtraCats />
                <ExtraDogs />
                <Lifestyle />
                <Signature />

                <div class="col-12">
                    <ul class="actions">
                        <li><input type="submit" value="Send" class="primary" /></li>
                        <li><input type="button" value="Reset" onclick="dynamicInputReset();" /></li>
                    </ul>
                </div>
            </div>
        </form>
    </div>
</section>
<script is:inline src="/assets/js/jquery.min.js"></script>
<script is:inline>
    const $form = $('form');
    $form.on('submit', handleSubmit);

    function handleSubmit($event) {
        $event.preventDefault();
        handleExtraAnimal($event, "cat");
        handleExtraAnimal($event, "dog");
        $event.currentTarget.submit();

    }

    function handleExtraAnimal($event, animalType) {
        const $data = new FormData($event.target);

        const $allExtraCatKeys = Array.from($data.keys()).filter(key => RegExp(`extra-${animalType}-`).test(key));
        const $regExp = /\[([^\]]+)\]/;
        console.log($allExtraCatKeys)
        const $uniqueExtraCatIds = [... new Set($allExtraCatKeys.map(elem => elem.match($regExp)[1]))];

        const $uniqueExtraCatKeys = [... new Set($allExtraCatKeys.map(elem => elem.match($regExp)[1]))];

        let $extraCats = {};
        $uniqueExtraCatKeys.forEach(catId => {
            let $catKeys = ($allExtraCatKeys.filter(key => RegExp(`${catId}`).test(key)));
            $extraCats[catId] = {};
            $catKeys.forEach(elem => $extraCats[catId][elem] = $data.get(elem))
        })

        const $extraCatsStringified = JSON.stringify($extraCats);

        const $extraCatsSecret = $(`input[name=extra-${animalType}s-secret]`);
        $extraCatsSecret.val($extraCatsStringified);
        console.log($extraCatsStringified);
    }
</script>
